rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users Collection - users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Workspaces
    match /workspaces/{workspaceId} {
      // Get (single document): Members can read, OR anyone can read public workspaces
      allow get: if request.auth != null && (
        exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) ||
        resource.data.type == 'public'
      );
      
      // List (query): Only allow querying PUBLIC workspaces (for invite code lookup)
      // This avoids the exists() check which fails for collection queries
      allow list: if request.auth != null && resource.data.type == 'public';

      // Create: Authenticated users can create if they set themselves as owner
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;

      // Update: Only the owner can update
      allow update: if request.auth != null && resource.data.ownerId == request.auth.uid;

      // Delete: Owner can delete if workspace is not protected
      allow delete: if request.auth != null 
        && resource.data.ownerId == request.auth.uid 
        && (resource.data.isProtected == null || resource.data.isProtected == false);

      // Workspace Members subcollection
      match /members/{memberId} {
        // Read: Any authenticated user can read member docs
        allow read: if request.auth != null;
        
        // Create: Owner can add anyone, OR user can add themselves to public workspaces
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid ||
          (request.auth.uid == memberId && get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.type == 'public')
        );
        
        // Delete: Owner can remove anyone, OR user can remove themselves
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid ||
          request.auth.uid == memberId
        );
        
        // Update: Only owner can update member roles
        allow update: if request.auth != null && 
          get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid;
      }

      // Pages subcollection
      match /pages/{pageId} {
        // Read: Members only
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid));
        
        // Write: Owner OR (member AND membersCanEdit is true)
        allow write: if request.auth != null && (
          get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid ||
          (
            exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) &&
            get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.membersCanEdit == true
          )
        );
      }
    }
  }
}
